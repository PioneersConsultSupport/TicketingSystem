<div class="ticket-details-container p-6 bg-white rounded-2xl shadow-lg" *ngIf="isLoaded">
    <!-- Header -->
    <div class="header-flex flex items-center gap-3 mb-4">
        <mat-icon color="primary" class="header-icon">confirmation_number</mat-icon>
        <h2 class="title-text text-2xl font-bold">{{ "Ticket Details" | translate }}</h2>
    </div>

    <!-- Form -->
    <form [formGroup]="form" class="ticket-form grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Title -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('title')">
            <mat-label>{{ "Title" | translate }}</mat-label>
            <input matInput formControlName="title" />
            <mat-error *ngIf="form.get('title')?.invalid">
                {{ "Title is required" | translate }}
            </mat-error>
        </mat-form-field>

        <!-- Support Option -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('supportOptionId')">
            <mat-label>{{ "Support Option" | translate }}</mat-label>
            <mat-select formControlName="supportOptionId">
                <mat-option *ngFor="let option of supportOptions" [value]="option.id">{{ option.name }}</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Assigned To -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('assignedToId')">
            <mat-label>{{ "Assigned To" | translate }}</mat-label>
            <mat-select formControlName="assignedToId">
                <mat-option *ngFor="let user of users" [value]="user.id">{{ user.userName }}</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Priority -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('priorityId')">
            <mat-label>{{ "Priority" | translate }}</mat-label>
            <mat-select formControlName="priorityId">
                <mat-option *ngFor="let p of ticketPriority" [value]="p.id">{{ p.name }}</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Status -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('statusId')">
            <mat-label>{{ "Status" | translate }}</mat-label>
            <mat-select formControlName="statusId">
                <mat-option *ngFor="let s of ticketStatus" [value]="s.id">{{ s.name }}</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Category -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('categoryId')">
            <mat-label>{{ "Category" | translate }}</mat-label>
            <mat-select formControlName="categoryId">
                <mat-option *ngFor="let c of categories" [value]="c.id">{{ c.name }}</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Subcategory -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('subcategoryId') && subcategories.length">
            <mat-label>{{ "Subcategory" | translate }}</mat-label>
            <mat-select formControlName="subcategoryId">
                <mat-option *ngFor="let sc of subcategories" [value]="sc.id">{{ sc.name }}</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Start Date -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('startDate')">
            <mat-label>{{ "Start Date" | translate }}</mat-label>
            <input matInput [matDatepicker]="startPicker" [max]="form.get('deliveryDate')?.value"
                formControlName="startDate" />
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
            <mat-error *ngIf="form.get('startDate')?.hasError('required')">{{ "Start Date is required" | translate
                }}</mat-error>
        </mat-form-field>

        <!-- Delivery Date -->
        <mat-form-field appearance="outline" class="w-full" *ngIf="shouldShow('deliveryDate')">
            <mat-label>{{ "Delivery Date" | translate }}</mat-label>
            <input matInput [matDatepicker]="deliveryPicker" [min]="form.get('startDate')?.value"
                formControlName="deliveryDate" />
            <mat-datepicker-toggle matSuffix [for]="deliveryPicker"></mat-datepicker-toggle>
            <mat-datepicker #deliveryPicker></mat-datepicker>
            <mat-error *ngIf="form.get('deliveryDate')?.hasError('required')">{{ "Delivery Date is required" | translate
                }}</mat-error>
        </mat-form-field>

        <!-- Description -->
        <mat-form-field appearance="outline" class="w-full md:col-span-3" *ngIf="shouldShow('description')">
            <mat-label>{{ "Description" | translate }}</mat-label>
            <textarea matInput formControlName="description" rows="3"></textarea>
            <mat-error *ngIf="form.get('description')?.invalid">{{ "Description is required" | translate }}</mat-error>
        </mat-form-field>
    </form>

    <!-- Actions -->
    <div class="actions mt-6 flex justify-end gap-3">
        <button mat-stroked-button color="warn" type="button" (click)="cancel()">Cancel</button>
        <button mat-flat-button color="primary" (click)="save()" [disabled]="form.invalid">Update</button>
    </div>
</div>

<!-- Tabs Section -->
<div class="ticket-details-container p-6 bg-white rounded-2xl shadow-lg mt-6" *ngIf="isLoaded">
    <mat-tab-group class="ticket-tabs" mat-stretch-tabs>
        <mat-tab label="{{ 'Ticket Comments' | translate }}">
            <app-ticket-comments [ticketId]="ticket.id"></app-ticket-comments>
        </mat-tab>
        <mat-tab label="{{ 'Ticket History' | translate }}">
            <app-ticket-history [ticketId]="ticket.id"></app-ticket-history>
        </mat-tab>
        <mat-tab label="{{ 'Delivery Date Changes' | translate }}">
            <app-delivery-date-history [ticketId]="ticket.id"></app-delivery-date-history>
        </mat-tab>
    </mat-tab-group>
</div>