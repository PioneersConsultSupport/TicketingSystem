<div class="ticket-details-container" *ngIf="isLoaded">
  <!-- Header + Form Card -->
  <mat-card class="ticket-header">
    <mat-card-header>
      <div class="header-flex">
        <mat-icon color="primary" class="header-icon">confirmation_number</mat-icon>
        <mat-card-title>{{ "Ticket Details" | translate }}</mat-card-title>
      </div>
    </mat-card-header>

    <mat-card-content>
      <!-- Ticket Form -->
      <form [formGroup]="form" class="ticket-form">
        <mat-form-field appearance="outline" *ngIf="shouldShow('title')">
          <mat-label>{{ "Title" | translate }}</mat-label>
          <input matInput formControlName="title" />
          <mat-error *ngIf="form.get('title')?.invalid">
            {{ "Title is required" | translate }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('supportOptionId')">
          <mat-label>{{ "Support Option" | translate }}</mat-label>
          <mat-select formControlName="supportOptionId">
            <mat-option *ngFor="let option of supportOptions" [value]="option.id">{{ option.name }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('assignedToId')">
          <mat-label>{{ "Assigned To" | translate }}</mat-label>
          <mat-select formControlName="assignedToId">
            <mat-option *ngFor="let user of users" [value]="user.id">{{ user.userName }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('priorityId')">
          <mat-label>{{ "Priority" | translate }}</mat-label>
          <mat-select formControlName="priorityId">
            <mat-option *ngFor="let p of ticketPriority" [value]="p.id">{{ p.name }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('statusId')">
          <mat-label>{{ "Status" | translate }}</mat-label>
          <mat-select formControlName="statusId">
            <mat-option *ngFor="let s of ticketStatus" [value]="s.id">{{ s.name }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('categoryId')">
          <mat-label>{{ "Category" | translate }}</mat-label>
          <mat-select formControlName="categoryId">
            <mat-option *ngFor="let c of categories" [value]="c.id">{{ c.name }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('subcategoryId') && subcategories.length > 0">
          <mat-label>{{ "Subcategory" | translate }}</mat-label>
          <mat-select formControlName="subcategoryId">
            <mat-option *ngFor="let sc of subcategories" [value]="sc.id">{{ sc.name }}</mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('subcategoryId')?.hasError('required')">
            {{ "Subcategory is required" | translate }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('startDate')">
          <mat-label>{{ "Start Date" | translate }}</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate" [max]="form.get('deliveryDate')?.value"/>
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="shouldShow('deliveryDate')">
          <mat-label>{{ "Delivery Date" | translate }}</mat-label>
          <input matInput [matDatepicker]="deliveryPicker" formControlName="deliveryDate" [min]="form.get('startDate')?.value"/>
          <mat-datepicker-toggle matSuffix [for]="deliveryPicker"></mat-datepicker-toggle>
          <mat-datepicker #deliveryPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width" *ngIf="shouldShow('description')">
          <mat-label>{{ "Description" | translate }}</mat-label>
          <textarea matInput formControlName="description" rows="5" placeholder="Enter detailed description..."></textarea>
        </mat-form-field>
      </form>

      <!-- Actions -->
      <div class="actions">
        <button mat-stroked-button color="warn" (click)="cancel()">Cancel</button>
        <button mat-flat-button color="primary" (click)="save()" [disabled]="form.invalid">Update</button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabs Card -->
  <mat-card class="ticket-tabs-card">
    <mat-card-header>
      <div class="header-flex">
        <mat-icon>list</mat-icon>
        <mat-card-title>{{ 'Additional Details' | translate }}</mat-card-title>
      </div>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group mat-stretch-tabs>
        <mat-tab label="{{ 'Ticket Comments' | translate }}">
          <app-ticket-comments [ticketId]="ticket.id"></app-ticket-comments>
        </mat-tab>
        <mat-tab label="{{ 'Ticket History' | translate }}">
          <app-ticket-history [ticketId]="ticket.id"></app-ticket-history>
        </mat-tab>
        <mat-tab label="{{ 'Delivery Date Changes' | translate }}">
          <app-delivery-date-history [ticketId]="ticket.id"></app-delivery-date-history>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
